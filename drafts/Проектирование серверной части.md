# Проектирование серверной части онлайн-калькулятора
## Проектирование структуры серверной части онлайн-калькулятора
Согласно техническому заданию, разрабатывать серверную часть необходимо на языке программирования Python. API для онлайн-калькулятора предельно прост, содержит всего три конечных точки, взаимодействие с базой данных или другими приложениями не предусмотрено. С учетом изложенного для разработки серверной части онлайн-калькулятора решено использовать web-фреймворк FastAPI. FastAPI является проектом с открытым исходным кодом, позволяет разрабатывать API на основе открытых стандартов OpenAPI, автоматически генерировать документацию для API. FastAPI основан на python библиотеке Pydantic, что позволяет использовать иерархические модели данных Pydantic, валидаторы данных и документирование схемы данных в виде JSON Schema, для объектов любой глубины вложенности. Кроме того, в FastAPI имеется тестовый клиент для организации автоматического тестирования API. Таким образом, непосредственно API планируется реализовать с использованием web-фреймворка FastAPI, с реализацией классов, описанных на диаграмме классов для API, с помощью библиотеки Pydantic.

Онлайн-калькулятор разрабатывается как проект для проведения практических занятий со студентами. Основная цель - представить студентам возможность участия в разработке web-приложения с минимальными затратами и навыками разработки. Предполагается, что студент может добавить новый алгоритм в онлайн-калькулятор, описав декларативно его структуру - название, описание, конфигурацию входных и выходных данных, и разработав функцию на языке программирования python, которая этот алгоритм реализует. В результате основная задача серверной части онлайн-калькулятора - организация проверки и сборки алгоритмов из файлов с описанием и исходным кодом алгоритма, подготовленных студентами.

Предполагается, что в проекте с исходным кодом для серверной части будет создан отдельный каталог с именем algorithms. В это каталоге каждый алгоритм будет располагаться в отдельном подкаталоге. Имя подкаталога можно использовать в качестве уникального имени для алгоритма. Описание алгоритма будет располагаться в JSON файле с названием definition.json, реализация функции для алгоритма в файле main.py, кроме того, в файле tests.py будет расположен набор модульных тестов для автоматической проверки реализации алгоритма. В результате каждый алгоритм будет представлять собой набор однотипных файлов в подкаталогах каталога algorithms и сборку онлайн-калькулятора можно будет осуществить последовательно обрабатывая указанные подкаталоги. При сборке алгоритма в онлайн-калькулятор необходимо убедиться, что он корректно описан и реализован. Для проверки описания алгоритма можно использовать валидацию данных в формате JSON с помощью JSON Schema - языка описания структуры JSON. При сборке алгоритма нужно запускать на выполнение набор автотестов, проверяющих работу функцию и прерывать сборку при провале теста. Также необходимо проверять, что функция для алгоритма принимает набор параметров, описанный в файле definition.json, и возвращает набор результатов, описанный в файле. Для организации такой проверки, планируется добавить в описание входных и выходных данных значение по умолчанию, тогда значения по умолчанию для входных данных можно передать в функцию, выполнить ее и проверить, что выходные данные соответствуют заданным значениям по умолчанию.

В результате серверная часть должна содержать класс для описания структуры входных/выходных данных, класс, описывающий алгоритм и предоставляющий возможность для его выполнения, класс, конструирующий алгоритмы из исходного кода, написанного студентами, и класс, представляющий набор алгоритмов и реализующий функциональность для выполнения запросов к API. Указанные классы реализуют внутреннюю логику и составляют ядро системы, будут разработаны на чистом python. Для проектирования структуры серверной части онлайн-калькулятора использован инструмент моделирования Visual Paradigm. В UML-модель, разработанную на этапе анализа, добавлена диаграмма классов, представляющая ядро системы. Разработанная диаграмма классов представлена на рисунке 1.

![Диаграмма классов](https://github.com/OMMAT-HSE/algoscalc-docs/blob/task-27/uml-model/images/class_diagram.png)

Рисунок 1. Диаграмма классов.

Класс **DataType** является перечислением, представляет допустимые типы данных для входных и выходных данных. Возможными значениями класса являются INT, FLOAT, STRING, BOOL, соответствующие типам данных языка python int, float, str, bool. Класс имеет свойство type, возвращающее соответствующий тип данных языка python и свойство types, возвращающее список допустимых типов данных.

Класс **DataShape** является перечислением, представляет допустимые размерности для входных и выходных данных. Возможными значениями класса являются SCALAR, LIST, MATRIX, соответствующие скалярному значению, списку скалярных значений и двумерную матрицу соответственно. Класс имеет метод get_shape_errors, проверяющий соответствие проверяемого параметра размерности и возвращающее текст ошибки или значение None, если проверка не выявила ошибок.

Класс **DataElement** представляет элемент входных или выходных данных для алгоритма. DataElement содержит следующие приватные атрибуты:
- __name - уникальное имя элемента входных/выходных данных,
- __title - название имя элемента входных/выходных данных,
- __description - описание,
- __data_shape - тип данных (DataShape),
- __data_type - размерность данных (DataElement)
- __default_value - значение по умолчанию.

Для каждого приватного поля в классе DataElement имеется соответствующее публичное свойство для получения значения приватного поля. В классе имеется публичный метод get_check_value_errors, проверяющий соответствие проверяемого параметра типу данных и размерности и возвращающее текст ошибки или значение None, если проверка не выявила ошибок. Также имеются приватные методы __check_scalar_value, __check_list_value, __check_matrix_value, проверяющие корректность значения для скалярного, списочного или матричного значения соответственно.

Класс **Algorithm** представляет непосредственно алгоритм с описанием и методом для его выполнения. Algorithm содержит следующие приватные атрибуты:
- __name - уникальное имя алгоритма,
- __title - название алгоритма,
- __description - описание алгоритма,
- __execute_timeout - время отведенное для выполнения алгоритма,
- __parameters - словарь входных данных, где уникальное имя используется в качестве ключа, а объект DataElement в качестве значения,
- __outputs - список выходных данных, где уникальное имя используется в качестве ключа, а объект DataElement в качестве значения,
- __execute_method - метод, реализующий алгоритм, импортируемый из исходного кода студентов.

Для доступа на просмотр приватных полей реализованы следующие свойства:
- name - уникальное имя алгоритма,
- title - название алгоритма,
- description - описание алгоритма,
- execute_timeout - время отведенное для выполнения алгоритма,
- parameters - кортеж входных данных (DataElement),
- outputs - кортеж выходных данных (DataElement).

Публичными методами класса Algorithm являются:
- add_parameter - добавляет в словарь __parameters элемент входных данных, переданный в параметре parameter.
- add_output - добавляет в словарь __outputs элемент выходных данных, переданный в параметре output.
- add_execute_method - сохраняет в поле __execute_method переданный в параметре method метод, реализующий алгоритм.
- get_test_errors - запускает тестовое выполнение алгоритма со входными данными, заданными по умолчанию. Метод возвращает текст ошибки или значение None, если выполнение алгоритма прошло без ошибок.
- execute - запускает алгоритм на выполнение со входными параметрами, переданными в виде словаря в переменной params. Возвращает словарь с результатами выполнения алгоритма.

Приватными методами класса Algorithm являются:
- __check_method_raises_ex - проверяет возможность добавления метода в алгоритм. Вызывает исключение, если проверка выявила ошибки.
- __check_parameters_raises_ex - проверяет соответствие переданных параметров описанным входным данным. Вызывает исключение, если проверка выявила ошибки.
- __check_outputs_raises_ex - проверяет соответствие полученных результатов описанным выходным данным. Вызывает исключение, если проверка выявила ошибки.

Класс **AlgorithmBuilder** создает объекты класса Algorithm из файлов с исходным кодом. Класс содержит следующие приватные атрибуты:
- __definition_file_name - название файла с описанием алгоритма.
- __function_file_name - название файла с методом для алгоритма.
- __test_file_name - название файла с автотестами для метода алгоритма.
- __schema_file_path - путь к файлу JSON Schema для валидации описания алгоритма. 
- __algorithm_config - словарь с параметрами для создания алгоритма, на данный момент имеется один параметр - execute_timeout - время отведенное для выполнения алгоритма.

В классе AlgorithmBuilder имеется один публичный метод - build_algorithm, для создания объекта Algorithm на основе файлов в указанном каталоге.

Приватными методами класса Algorithm являются:
- __validate_definition_raises_ex - осуществляет валидацию описания алгоритма на основе JSON Schema. Вызывает исключение, если проверка выявила ошибки.
- __get_data_element - создает элемент данных (DataElement), для включения во входные/выходные данные алгоритма.
- __get_function - импортирует функцию для алгоритма из файла с исходным кодом.
- __test_function - запускает выполнение автотестов для импортируемой функции. Возвращает результат выполнения автотестов.

Класс **AlgorithmCollection** представляет собой набор объектов класса Algorithm, созданных объектом класса AlgorithmBuilder. Именно объект класса AlgorithmCollection предоставляет данные, необходимые для API серверной части онлайн-калькулятора. Класс имеет одно приватное поле __algorithms, содержащее словарь с уникальными именами алгоритмов в качестве ключей и объекты класса Algorithm в качестве значений.

Публичными методами класса AlgorithmCollection являются:
- has_algorithm - проверяет есть ли в словаре ключ с именем алгоритма, переданным в параметре algorithm_name.
- get_name_title_dict - возвращает словарь с уникальными именами алгоритмов в качестве ключей и названиями алгоритмов в качестве значений. 
- get_algorithm - возвращает объект класса Algorithm с именем алгоритма, переданным в параметре algorithm_name.
- get_algorithm_result - возвращает результат выполнения алгоритма по имени, переданным в параметре algorithm_name, со входными параметрами, переданными в параметре params.

## Проектирование взаимодействия элементов серверной части онлайн-калькулятора