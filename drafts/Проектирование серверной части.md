# Проектирование серверной части онлайн-калькулятора
## Проектирование структуры серверной части онлайн-калькулятора
Согласно техническому заданию, разрабатывать серверную часть необходимо на языке программирования Python. API для онлайн-калькулятора предельно прост, содержит всего три конечных точки, взаимодействие с базой данных или другими приложениями не предусмотрено. С учетом изложенного для разработки серверной части онлайн-калькулятора решено использовать web-фреймворк FastAPI. FastAPI является проектом с открытым исходным кодом, позволяет разрабатывать API на основе открытых стандартов OpenAPI, автоматически генерировать документацию для API. FastAPI основан на python библиотеке Pydantic, что позволяет использовать иерархические модели данных Pydantic, валидаторы данных и документирование схемы данных в виде JSON Schema, для объектов любой глубины вложенности. Кроме того, в FastAPI имеется тестовый клиент для организации автоматического тестирования API. Таким образом, непосредственно API планируется реализовать с использованием web-фреймворка FastAPI, с реализацией классов, описанных на диаграмме классов для API, с помощью библиотеки Pydantic.

Онлайн-калькулятор разрабатывается как проект для проведения практических занятий со студентами. Основная цель - представить студентам возможность участия в разработке web-приложения с минимальными затратами и навыками разработки. Предполагается, что студент может добавить новый алгоритм в онлайн-калькулятор, описав декларативно его структуру - название, описание, конфигурацию входных и выходных данных, и разработав функцию на языке программирования python, которая этот алгоритм реализует. В результате основная задача серверной части онлайн-калькулятора - организация проверки и сборки алгоритмов из файлов с описанием и исходным кодом алгоритма, подготовленных студентами.

Предполагается, что в проекте с исходным кодом для серверной части будет создан отдельный каталог с именем algorithms. В это каталоге каждый алгоритм будет располагаться в отдельном подкаталоге. Имя подкаталога можно использовать в качестве уникального имени для алгоритма. Описание алгоритма будет располагаться в JSON файле с названием definition.json, реализация функции для алгоритма в файле main.py, кроме того, в файле tests.py будет расположен набор модульных тестов для автоматической проверки реализации алгоритма. В результате каждый алгоритм будет представлять собой набор однотипных файлов в подкаталогах каталога algorithms и сборку онлайн-калькулятора можно будет осуществить последовательно обрабатывая указанные подкаталоги. При сборке алгоритма в онлайн-калькулятор необходимо убедиться, что он корректно описан и реализован. Для проверки описания алгоритма можно использовать валидацию данных в формате JSON с помощью JSON Schema - языка описания структуры JSON. При сборке алгоритма нужно запускать на выполнение набор автотестов, проверяющих работу функцию и прерывать сборку при провале теста. Также необходимо проверять, что функция для алгоритма принимает набор параметров, описанный в файле definition.json, и возвращает набор результатов, описанный в файле. Для организации такой проверки, планируется добавить в описание входных и выходных данных значение по умолчанию, тогда значения по умолчанию для входных данных можно передать в функцию, выполнить ее и проверить, что выходные данные соответствуют заданным значениям по умолчанию.

В результате серверная часть должна содержать класс для описания структуры входных/выходных данных, класс, описывающий алгоритм и предоставляющий возможность для его выполнения, класс, конструирующий алгоритмы из исходного кода, написанного студентами, и класс, представляющий набор алгоритмов и реализующий функциональность для выполнения запросов к API. Указанные классы реализуют внутреннюю логику и составляют ядро системы, будут разработаны на чистом python. Для проектирования структуры серверной части онлайн-калькулятора использован инструмент моделирования Visual Paradigm. В UML-модель, разработанную на этапе анализа, добавлена диаграмма классов, представляющая ядро системы. Разработанная диаграмма классов представлена на рисунке 1.

![Диаграмма классов](https://github.com/OMMAT-HSE/algoscalc-docs/blob/task-27/uml-model/images/class_diagram.png)

Рисунок 1. Диаграмма классов.

Класс **DataType** является перечислением, представляет допустимые типы данных для входных и выходных данных. Возможными значениями класса являются INT, FLOAT, STRING, BOOL, соответствующие типам данных языка python int, float, str, bool. Класс имеет свойство type, возвращающее соответствующий тип данных языка python и свойство types, возвращающее список допустимых типов данных.

Класс **DataShape** является перечислением, представляет допустимые размерности для входных и выходных данных. Возможными значениями класса являются SCALAR, LIST, MATRIX, соответствующие скалярному значению, списку скалярных значений и двумерную матрицу соответственно. Класс имеет метод get_shape_errors, проверяющий соответствие проверяемого параметра размерности и возвращающее текст ошибки или значение None, если проверка не выявила ошибок.

Класс **DataElement** представляет элемент входных или выходных данных для алгоритма. DataElement содержит следующие приватные атрибуты:
- __name - уникальное имя элемента входных/выходных данных,
- __title - название имя элемента входных/выходных данных,
- __description - описание,
- __data_shape - тип данных (DataShape),
- __data_type - размерность данных (DataElement)
- __default_value - значение по умолчанию.

Для каждого приватного поля в классе DataElement имеется соответствующее публичное свойство для получения значения приватного поля. В классе имеется публичный метод get_check_value_errors, проверяющий соответствие проверяемого параметра типу данных и размерности и возвращающее текст ошибки или значение None, если проверка не выявила ошибок. Также имеются приватные методы __check_scalar_value, __check_list_value, __check_matrix_value, проверяющие корректность значения для скалярного, списочного или матричного значения соответственно.

Класс **Algorithm** представляет непосредственно алгоритм с описанием и методом для его выполнения. Algorithm содержит следующие приватные атрибуты:
- __name - уникальное имя алгоритма,
- __title - название алгоритма,
- __description - описание алгоритма,
- __execute_timeout - время отведенное для выполнения алгоритма,
- __parameters - словарь входных данных, где уникальное имя используется в качестве ключа, а объект DataElement в качестве значения,
- __outputs - список выходных данных, где уникальное имя используется в качестве ключа, а объект DataElement в качестве значения,
- __execute_method - метод, реализующий алгоритм, импортируемый из исходного кода студентов.

Для доступа на просмотр приватных полей реализованы следующие свойства:
- name - уникальное имя алгоритма,
- title - название алгоритма,
- description - описание алгоритма,
- execute_timeout - время отведенное для выполнения алгоритма,
- parameters - кортеж входных данных (DataElement),
- outputs - кортеж выходных данных (DataElement).

Публичными методами класса Algorithm являются:
- add_parameter - добавляет в словарь __parameters элемент входных данных, переданный в параметре parameter.
- add_output - добавляет в словарь __outputs элемент выходных данных, переданный в параметре output.
- add_execute_method - сохраняет в поле __execute_method переданный в параметре method метод, реализующий алгоритм.
- get_test_errors - запускает тестовое выполнение алгоритма со входными данными, заданными по умолчанию. Метод возвращает текст ошибки или значение None, если выполнение алгоритма прошло без ошибок.
- execute - запускает алгоритм на выполнение со входными параметрами, переданными в виде словаря в переменной params. Возвращает словарь с результатами выполнения алгоритма.

Приватными методами класса Algorithm являются:
- __check_method_raises_ex - проверяет возможность добавления метода в алгоритм. Вызывает исключение, если проверка выявила ошибки.
- __check_parameters_raises_ex - проверяет соответствие переданных параметров описанным входным данным. Вызывает исключение, если проверка выявила ошибки.
- __check_outputs_raises_ex - проверяет соответствие полученных результатов описанным выходным данным. Вызывает исключение, если проверка выявила ошибки.

Класс **AlgorithmBuilder** создает объекты класса Algorithm из файлов с исходным кодом. Класс содержит следующие приватные атрибуты:
- __definition_file_name - название файла с описанием алгоритма.
- __function_file_name - название файла с методом для алгоритма.
- __test_file_name - название файла с автотестами для метода алгоритма.
- __schema_file_path - путь к файлу JSON Schema для валидации описания алгоритма. 
- __algorithm_config - словарь с параметрами для создания алгоритма, на данный момент имеется один параметр - execute_timeout - время отведенное для выполнения алгоритма.

В классе AlgorithmBuilder имеется один публичный метод - build_algorithm, для создания объекта Algorithm на основе файлов в указанном каталоге.

Приватными методами класса Algorithm являются:
- __validate_definition_raises_ex - осуществляет валидацию описания алгоритма на основе JSON Schema. Вызывает исключение, если проверка выявила ошибки.
- __get_data_element - создает элемент данных (DataElement), для включения во входные/выходные данные алгоритма.
- __get_function - импортирует функцию для алгоритма из файла с исходным кодом.
- __test_function - запускает выполнение автотестов для импортируемой функции. Возвращает результат выполнения автотестов.

Класс **AlgorithmCollection** представляет собой набор объектов класса Algorithm, созданных объектом класса AlgorithmBuilder. Именно объект класса AlgorithmCollection предоставляет данные, необходимые для API серверной части онлайн-калькулятора. Класс имеет одно приватное поле __algorithms, содержащее словарь с уникальными именами алгоритмов в качестве ключей и объекты класса Algorithm в качестве значений.

Публичными методами класса AlgorithmCollection являются:
- has_algorithm - проверяет есть ли в словаре ключ с именем алгоритма, переданным в параметре algorithm_name.
- get_name_title_dict - возвращает словарь с уникальными именами алгоритмов в качестве ключей и названиями алгоритмов в качестве значений. 
- get_algorithm - возвращает объект класса Algorithm с именем алгоритма, переданным в параметре algorithm_name.
- get_algorithm_result - возвращает результат выполнения алгоритма по имени, переданным в параметре algorithm_name, со входными параметрами, переданными в параметре params.

## Проектирование взаимодействия элементов серверной части онлайн-калькулятора
На основе диаграммы прецедентов, функциональных требований, разработанных на этапе анализа, а также диаграммы классов и описания API выполнено проектирование взаимодействия элементов структуры онлайн-калькулятора. Серверная часть онлайн-калькулятора реализует прецеденты "Просмотреть список алгоритмов" (GET запрос к конечной точке /api/algorithms), "Просмотреть описание алгоритма" (GET запрос к конечной точке /api/algorithms/{algorithm_name}) и "Выполнить алгоритм" (POST запрос к конечной точке /api/algorithms/{algorithm_name}). Кроме того, серверная часть осуществляет сборку алгоритмов из исходного кода, написанного студентами. Сборка алгоритмов не описывалась как прецедент, так как этот процесс скрыт от пользователя, можно считать, что сборка алгоритмов входит в прецедент "Просмотреть список алгоритмов". В ходе проектирования, с помощью инструмента моделирования Visual Paradigm, для прецедентов разработаны диаграммы последовательностей, отражающие взаимодействие элементов серверной части онлайн-калькулятора. 

На рисунке 2 представлена диаграмма последовательностей для основного потока прецедента "Просмотреть список алгоритмов". В основном потоке объект класса AlgorithmCollection обращается в цикле к входящим в него объектам класса Algorithm и запрашивает значения свойств name и title. В результате объект класса AlgorithmCollection возвращает словарь с ключами name и значениями title для каждого алгоритма.

![Диаграмма последовательностей для основного потока прецедента "Просмотреть список алгоритмов"](https://github.com/OMMAT-HSE/algoscalc-docs/blob/task-27/uml-model/images/sequence_diagram_get_algorithms.png)

Рисунок 2. Диаграмма последовательностей для основного потока прецедента "Просмотреть список алгоритмов".

Описание системных операций, представленных на диаграмме.</br>
<u>Имя</u>: **get_name_title_dict()**.</br>
<u>Обязанности</u>: предоставить словарь, в котором для каждого из имеющихся алгоритмов имеется ключ с уникальным именем алгоритма и значение с названием алгоритма.</br>
<u>Ссылки</u>: прецедент "Просмотреть список алгоритмов".</br>
<u>Примечания</u>: нет.</br>
<u>Исключения</u>: нет.</br>
<u>Предусловия</u>: создан объект algorithms класса AlgorithmCollection, содержащих набор объектов класса Algorithm.</br>
<u>Постусловия</u>: создан объект dict - словарь, в котором для каждого из имеющихся алгоритмов имеется ключ с уникальным именем алгоритма и значение с названием алгоритма.</br>

На рисунке 3 представлена диаграмма последовательностей для наполнения объекта класса AlgorithmCollection. Объект класса AlgorithmCollection создает объект класса AlgorithmBuilder, который в цикле создает из файлов с исходным кодом объекты класса Algorithm, обрабатывая каталоги. После создания объекта класса Algorithm производится добавление входных и выходных данных и добавление метода, реализующего алгоритм. Созданные объекты класса Algorithm возвращаются объекту класса AlgorithmCollection и включаются в словарь __algorithms.  

![Диаграмма последовательностей для наполнения объекта класса AlgorithmCollection](https://github.com/OMMAT-HSE/algoscalc-docs/blob/task-27/uml-model/images/sequence_diagram_buld_algorithms.png)

Рисунок 3. Диаграмма последовательностей для наполнения объекта класса AlgorithmCollection.

Описание системных операций, представленных на диаграмме.</br>
<u>Имя</u>: **build_algorithm(path)**.</br>
<u>Обязанности</u>: создать объект класса Algorithm из файлов с исходным кодом в указанном каталоге.</br>
<u>Ссылки</u>: прецедент "Просмотреть список алгоритмов".</br>
<u>Примечания</u>: в параметре path указывается путь к каталогу с файлами исходного кода.</br>
<u>Исключения</u>: не найден файл с исходным кодом, описание алгоритма не проходит валидацию, метод для алгоритма не прошел проверку.</br>
<u>Предусловия</u>: нет.</br>
<u>Постусловия</u>: создан объект класса Algorithm из файлов с исходным кодом в указанном каталоге.</br>

<u>Имя</u>: **add_parameter(parameter)**.</br>
<u>Обязанности</u>: добавить параметр parameter в атрибут __parameters объекта класса Algorithm.</br>
<u>Ссылки</u>: прецедент "Просмотреть список алгоритмов".</br>
<u>Примечания</u>: в параметре parameter передается объект класса DataElement.</br>
<u>Исключения</u>: атрибут __parameters уже содержит параметр с указанным именем.</br>
<u>Предусловия</u>: создание объекта класса Algorithm.</br>
<u>Постусловия</u>: объект класса DataElement, переданный в параметре parameter, добавлен в словарь __parameters объекта класса Algorithm.</br>

<u>Имя</u>: **add_output(output)**.</br>
<u>Обязанности</u>: добавить элемент выходных данных output в атрибут __outputs объекта класса Algorithm.</br>
<u>Ссылки</u>: прецедент "Просмотреть список алгоритмов".</br>
<u>Примечания</u>: в параметре output передается объект класса DataElement.</br>
<u>Исключения</u>: атрибут __outputs уже содержит элемент выходных данных с указанным именем.</br>
<u>Предусловия</u>: создание объекта класса Algorithm.</br>
<u>Постусловия</u>: объект класса DataElement, переданный в параметре output, добавлен в словарь __outputs объекта класса Algorithm.</br>

<u>Имя</u>: **add_execute_method(method)**.</br>
<u>Обязанности</u>: добавить метод в атрибут __execute_method объекта класса Algorithm.</br>
<u>Ссылки</u>: прецедент "Просмотреть список алгоритмов".</br>
<u>Примечания</u>: в параметре method передается функция, импортированная из файла с исходным кодом.</br>
<u>Исключения</u>: метод для алгоритма не прошел проверку.</br>
<u>Предусловия</u>: создание объекта класса Algorithm.</br>
<u>Постусловия</u>: функция, переданная в параметре method, связана с атрибутом __execute_method объекта класса Algorithm.</br>

На рисунке 4 представлена диаграмма последовательностей для основного потока прецедента "Просмотреть описание алгоритма". В основном потоке объект класса AlgorithmCollection возвращает объект класса Algorithm с уникальным именем согласно указанному в параметре. 

![Диаграмма последовательностей для основного потока прецедента "Просмотреть описание алгоритма"](https://github.com/OMMAT-HSE/algoscalc-docs/blob/task-27/uml-model/images/sequence_diagram_get_algorithm.png)

Рисунок 4. Диаграмма последовательностей для основного потока прецедента "Просмотреть описание алгоритма".

Описание системных операций, представленных на диаграмме.</br>
<u>Имя</u>: **get_algorithm(algorithm_name)**.</br>
<u>Обязанности</u>: передать вызывающей стороне ссылку объект класса Algorithm.</br>
<u>Ссылки</u>: прецедент "Просмотреть описание алгоритма".</br>
<u>Примечания</u>: в параметре algorithm_name указывается уникальное имя алгоритма.</br>
<u>Исключения</u>: не найден алгоритм с указанным именем.</br>
<u>Предусловия</u>: создан объект algorithms класса AlgorithmCollection, содержащих набор объектов класса Algorithm.</br>
<u>Постусловия</u>: вызывающей стороне передана ссылка объект класса Algorithm.</br>

На рисунке 5 представлена диаграмма последовательностей для основного потока прецедента "Выполнить алгоритм". В основном потоке объект класса AlgorithmCollection обращается к объекту класса Algorithm, с уникальным именем согласно указанному в параметре, передает фактические значения для входных данных алгоритма и получает значения выходных данных. Проверки входных и выходных данных вынесены на отдельные диаграммы последовательностей.

![Диаграмма последовательностей для основного потока прецедента "Выполнить алгоритм"](https://github.com/OMMAT-HSE/algoscalc-docs/blob/task-27/uml-model/images/sequence_diagram_get_algorithm_result.png)

Рисунок 5. Диаграмма последовательностей для основного потока прецедента "Выполнить алгоритм".

Описание системных операций, представленных на диаграмме.</br>
<u>Имя</u>: **get_algorithm_result(algorithm_name, params)**.</br>
<u>Обязанности</u>: создать объект словарь с выходными данными, полученными в результате выполнения алгоритма.</br>
<u>Ссылки</u>: прецедент "Выполнить алгоритм".</br>
<u>Примечания</u>: в параметре algorithm_name указывается уникальное имя алгоритма, в параметре params передаются фактические значения входных данных для алгоритма.</br>
<u>Исключения</u>: не найден алгоритм с указанным именем, метод для алгоритма не прошел проверку, входные данные не соответствуют описанию алгоритма, время для выполнения алгоритма истекло, ошибка во время выполнения алгоритма, выходные данные не соответствуют описанию алгоритма.</br>
<u>Предусловия</u>: создан объект algorithms класса AlgorithmCollection, содержащих набор объектов класса Algorithm.</br>
<u>Постусловия</u>: создан объект словарь с выходными данными, полученными в результате выполнения алгоритма.</br>

<u>Имя</u>: **execute(params)**.</br>
<u>Обязанности</u>: создать объект словарь с выходными данными, полученными в результате выполнения алгоритма.</br>
<u>Ссылки</u>: прецедент "Выполнить алгоритм".</br>
<u>Примечания</u>: в параметре params передаются фактические значения входных данных для алгоритма.</br>
<u>Исключения</u>: метод для алгоритма не прошел проверку, входные данные не соответствуют описанию алгоритма, время для выполнения алгоритма истекло, ошибка во время выполнения алгоритма, выходные данные не соответствуют описанию алгоритма.</br>
<u>Предусловия</u>: создан объект класса Algorithm.</br>
<u>Постусловия</u>: создан объект словарь с выходными данными, полученными в результате выполнения алгоритма.</br>

<u>Имя</u>: **__check_method_raises_ex()**.</br>
<u>Обязанности</u>: проверить возможность выполнения алгоритма и вызвать исключение в случае наличия ошибок.</br>
<u>Ссылки</u>: прецедент "Выполнить алгоритм".</br>
<u>Примечания</u>: </br>
<u>Исключения</u>: метод для алгоритма не прошел проверку.</br>
<u>Предусловия</u>: создан объект класса Algorithm.</br>
<u>Постусловия</u>: вызов исключения в случае наличия ошибок.</br>

<u>Имя</u>: **__execute_method(params)**.</br>
<u>Обязанности</u>: создать объект словарь с выходными данными, полученными в результате выполнения алгоритма.</br>
<u>Ссылки</u>: прецедент "Выполнить алгоритм".</br>
<u>Примечания</u>: в параметре params передаются фактические значения входных данных для алгоритма.</br>
<u>Исключения</u>: время для выполнения алгоритма истекло, ошибка во время выполнения алгоритма.</br>
<u>Предусловия</u>: создан объект класса Algorithm.</br>
<u>Постусловия</u>: создан объект словарь с выходными данными, полученными в результате выполнения алгоритма.</br>

На рисунке 6 представлена диаграмма последовательностей для проверки входных данных, где для каждого параметра проверяется его значение на предмет соответствия размерности и типу данных, указанным в описании алгоритма. 

![Диаграмма последовательностей для проверки входных данных](https://github.com/OMMAT-HSE/algoscalc-docs/blob/task-27/uml-model/images/sequence_diagram_check_parameters.png)

Рисунок 6. Диаграмма последовательностей для проверки входных данных.

Описание системных операций, представленных на диаграмме.</br>
<u>Имя</u>: **get_check_value_error(value)**.</br>
<u>Обязанности</u>: проверить значение элемента входных данных на предмет соответствия размерности и типу данных.</br>
<u>Ссылки</u>: прецедент "Выполнить алгоритм".</br>
<u>Примечания</u>: в параметре value передаются фактическое значение элемента входных данных для алгоритма.</br>
<u>Исключения</u>: нет.</br>
<u>Предусловия</u>: создан объект класса Algorithm.</br>
<u>Постусловия</u>: создан объект строка содержащая ошибки проверки значения.</br>

Описание системных операций, представленных на диаграмме.</br>
<u>Имя</u>: **get_shape_error(value)**.</br>
<u>Обязанности</u>: проверить значение элемента входных данных на предмет соответствия размерности.</br>
<u>Ссылки</u>: прецедент "Выполнить алгоритм".</br>
<u>Примечания</u>: в параметре value передаются фактическое значение элемента входных данных.</br>
<u>Исключения</u>: нет.</br>
<u>Предусловия</u>: создан объект класса DataElement.</br>
<u>Постусловия</u>: создан объект строка содержащая ошибки проверки значения.</br>

Описание системных операций, представленных на диаграмме.</br>
<u>Имя</u>: **__check_scalar_value(value)**.</br>
<u>Обязанности</u>: проверить значение скалярного элемента входных данных на предмет соответствия типу данных.</br>
<u>Ссылки</u>: прецедент "Выполнить алгоритм".</br>
<u>Примечания</u>: в параметре value передаются фактическое значение элемента входных данных для алгоритма.</br>
<u>Исключения</u>: нет.</br>
<u>Предусловия</u>: создан объект класса DataElement.</br>
<u>Постусловия</u>: создан объект строка содержащая ошибки проверки значения.</br>

Описание системных операций, представленных на диаграмме.</br>
<u>Имя</u>: **__check_list_value(value)**.</br>
<u>Обязанности</u>: проверить значения в списке элемента входных данных на предмет соответствия типу данных.</br>
<u>Ссылки</u>: прецедент "Выполнить алгоритм".</br>
<u>Примечания</u>: в параметре value передаются фактическое значение элемента входных данных для алгоритма.</br>
<u>Исключения</u>: нет.</br>
<u>Предусловия</u>: создан объект класса DataElement.</br>
<u>Постусловия</u>: создан объект строка содержащая ошибки проверки значения.</br>

Описание системных операций, представленных на диаграмме.</br>
<u>Имя</u>: **__check_matrix_value(value)**.</br>
<u>Обязанности</u>: проверить значения в матрице элемента входных данных на предмет соответствия типу данных.</br>
<u>Ссылки</u>: прецедент "Выполнить алгоритм".</br>
<u>Примечания</u>: в параметре value передаются фактическое значение элемента входных данных для алгоритма.</br>
<u>Исключения</u>: нет.</br>
<u>Предусловия</u>: создан объект класса DataElement.</br>
<u>Постусловия</u>: создан объект строка содержащая ошибки проверки значения.</br>

На рисунке 7 представлена диаграмма последовательностей для проверки выходных данных, где для каждого элемента выходных данных проверяется его значение на предмет соответствия размерности и типу данных, указанным в описании алгоритма. В связи с тем, что входные и выходные данные представлены экземплярами класса DataElement, для проверки выходных данных используются те же системные операции, что и для проверки входных данных.

![Диаграмма последовательностей для проверки выходных данных](https://github.com/OMMAT-HSE/algoscalc-docs/blob/task-27/uml-model/images/sequence_diagram_check_outputs.png)

Рисунок 7. Диаграмма последовательностей для проверки выходных данных.

